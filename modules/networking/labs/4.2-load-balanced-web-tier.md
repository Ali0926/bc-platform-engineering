# Lab 02 â€“ Building a Load-Balanced Web Tier

**Objective:**  
Create a scalable and fault-tolerant web architecture using **Application Load Balancer (ALB)**.  
You'll deploy two web servers across multiple Availability Zones and test failover behavior.

---

## ğŸ§© Topology

```
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
Internet â‡„ ALB â”‚ HTTP:80    â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               /            \
       EC2-A (AZ1)       EC2-B (AZ2)
```

---

## âš™ï¸ Step 1 â€“ Launch One new Web Server and reuse the existing one

1. Use your **TrainingVPC** from Day 3 labs.
2. Add a new public subnet :
   - **Subnet name:** `PublicSubnetB` 
   - **Availability Zone:** `us-east-1b` (or your region's second AZ)
   - **IPv4 CIDR block:** `10.0.2.0/24`
   - Select Auto Assign IPv4 adress 
4. Launch one new **EC2 instance** name it **WebServer2** (Amazon Linux 2, t2.micro).
5. Edit VPC and assign TrainingVPC and subnet **PublicSubnetB**
6. Configure user data on bot **Webserver2** and **Webserver**:

```bash
#!/bin/bash
sudo yum install -y httpd
echo "Hello from $(hostname)" > /var/www/html/index.html
sudo systemctl start httpd
sudo systemctl enable httpd
```

> This will install a basic http server to enable testing of our loadbalancer !


---

## âš™ï¸ Step 2 â€“ Create a Target Group

1. Go to **EC2 â†’ Target Groups â†’ Create Target Group**.  
2. Choose **Instances** as target type.  
3. Name: `WebTG`  
4. Protocol: HTTP  
5. Port: 80  
6. VPC: `TrainingVPC`  
7. Add both EC2 instances as targets.  
8. Health check path: `/`

âœ… Wait until targets show as **healthy**.

---

## âš™ï¸ Step 3 â€“ Create Application Load Balancer

1. Go to **Load Balancers â†’ Create Load Balancer â†’ Application Load Balancer**  
2. Name: `TrainingALB`  
3. Scheme: Internet-facing  
4. Listeners: HTTP (80)  
5. Availability Zones: Select both AZs and attach public subnets.  
6. Security Group: Allow HTTP (80) from 0.0.0.0/0.  
7. Target Group: Select `WebTG`.

âœ… ALB will get a **DNS name** like `trainingalb-xxxx.elb.amazonaws.com`.

---

## âš™ï¸ Step 4 â€“ Test Load Balancing

1. Open your browser:

```
http://trainingalb-xxxx.elb.amazonaws.com
```

2. Refresh several times â€” you should alternate between:
- "Hello from ip-10-0-1-xx"
- "Hello from ip-10-0-2-xx"

âœ… ALB distributes traffic evenly between both servers.

---

## âš™ï¸ Step 5 â€“ Simulate Failover

1. Stop EC2-B in the AWS Console.  
2. Refresh your browser again.  
âœ… All traffic now goes to EC2-A (no downtime).

---

## ğŸ” Verification

| Test | Expected Result |
|------|------------------|
| ALB DNS resolves | âœ… Yes |
| Alternating responses | âœ… Yes |
| Health check status | âœ… Healthy |
| Failover on stop | âœ… Automatic |

---

## ğŸ’¡ Reflection

- What layer (L7 or L4) does the ALB operate at?  
- How do health checks improve availability?  
- Why use multiple AZs instead of one?

--- LAB Troubleshooting/Notes
## 1. Use a New, Non-Overlapping Subnet for PublicSubnetB

The original lab reused a CIDR that was already taken.

- **Already used in Lab 01:**
  - `10.0.1.0/24` â†’ PublicSubnetA  
  - `10.0.2.0/24` â†’ PrivateSubnetB  

For **PublicSubnetB**, we instead used a **new, unused** CIDR:

```text
10.0.20.0/24   â† works correctly
```

Any non-overlapping /24 inside `10.0.0.0/16` is fine, as long as it is **not** already used.

Also: make sure **Auto-assign public IPv4 address** is enabled on PublicSubnetB.

---

## 2. Use the Same Security Group for Both Web Servers

When launching **WebServer2**, we reused the existing security group:

```text
WebServerSG
```

Inbound rules on **WebServerSG**:

```text
HTTP  (80) â†’ 0.0.0.0/0
SSH   (22) â†’ 0.0.0.0/0 (lab only) or My IP
```

This allows:

- The ALB to reach the instances on port 80  
- You to SSH in for troubleshooting

---

## 3. Install and Start HTTP on Both Web Servers

Both **WebServer** and **WebServer2** need Apache/httpd running.

We used this user data (or ran these commands later via SSH):

```bash
#!/bin/bash
sudo yum install -y httpd
echo "Hello from $(hostname)" | sudo tee /var/www/html/index.html
sudo systemctl start httpd
sudo systemctl enable httpd
```

Quick test on each instance:

```bash
curl http://localhost
```

You should see the â€œHello from â€¦â€ message.

---

## 4. Attach the Target Group to the ALB Listener

During ALB creation, under **Listeners and routing**, we explicitly set:

- Listener: `HTTP : 80`
- Default action: **Forward to â†’ `WebTG`**

If you donâ€™t select `WebTG` here, the target group shows **â€œUnusedâ€** and health checks never run.

We also made sure the ALB was mapped to **both** public subnets:

- `PublicSubnetA` (us-east-1a)  
- `PublicSubnetB` (us-east-1b)

---

## 5. Use HTTP (Not HTTPS) to Test the ALB

The ALB only has an **HTTP : 80** listener and **no HTTPS** listener or certificate.

So you must use:

```text
http://trainingalb-xxxx.us-east-1.elb.amazonaws.com
```

If you try `https://â€¦`, the browser will time out.

---

## 6. Verify Targets Are Healthy Before Testing

Before expecting the ALB URL to work, check:

- **EC2 â†’ Target Groups â†’ WebTG â†’ Targets**

Both targets should show:

```text
Health status: Healthy
```

Only then will the ALB consistently serve traffic.
