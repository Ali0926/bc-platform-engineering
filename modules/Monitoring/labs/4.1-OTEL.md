# Lab 4.1: OpenTelemetry with FastAPI

## Overview

In this lab, you'll learn how OpenTelemetry (OTEL) enables distributed tracing and metrics for FastAPI applications. You'll see how traces help you observe your app, and how the provided FastAPI app in `src/` is already instrumented for you.

---

## What is OpenTelemetry?

**OpenTelemetry** is an open-source observability framework for collecting **traces**, **metrics**, and **logs** from your applications. It lets you see how requests flow through your system, where time is spent, and where errors occur.

---

## Why Instrument FastAPI with OTEL?

- **End-to-end visibility**: See every request, from API gateway to database
- **Performance monitoring**: Find bottlenecks and slow endpoints
- **Error tracking**: Trace errors across service boundaries
- **Business insights**: Correlate traces with business metrics

---

## Lab Steps

### 1. Review the Provided FastAPI App

- The `src/` directory contains a FastAPI app and a `run.sh` script for launching it.
- Explore the code in `src/` to see how the app is structured and how OTEL is integrated.
- Notice that the app uses the OpenTelemetry instrumenter to automatically trace requests—no need to manually define spans for each endpoint.

**Key files to review:**
- `src/main.py` (or similar): Entry point for the FastAPI app
- `src/run.sh`: How the app is started (may use `opentelemetry-instrument` CLI)

---

### 2. How Instrumentation Works Here

- The app is instrumented using the OpenTelemetry FastAPI integration.
- The `opentelemetry-instrument` command (see `run.sh`) wraps your app and automatically creates spans for each request/endpoint.
- You do **not** need to add manual span code for each route—OTEL handles this for you.
- If you want to trace specific business logic, you can add custom spans (see below).

---

### 3. Run and Observe

1. Start your FastAPI app using the provided `run.sh` script:
   ```bash
   ./src/run.sh
   ```
2. Trigger some API requests (e.g., with curl or your browser).
3. In your monitoring stack (Grafana/Tempo/Jaeger), look for traces from your app.

---

### 4. What to Look For

- Each API call should generate a trace with spans for each endpoint.
- You can see request/response times, errors, and context propagation.
- Try breaking an endpoint to see how errors are traced.

---

### 5. (Optional) Add a Custom Span

If you want to trace a specific function or code block, add a custom span in your code:

```python
from opentelemetry import trace
tracer = trace.get_tracer(__name__)

with tracer.start_as_current_span("my_custom_span"):
    # Your code here
    pass
```

This helps you see detailed timing for business logic.

---

## Summary

You have now:
- Learned what OpenTelemetry is and why it matters
- Seen how the provided FastAPI app is instrumented for tracing
- Viewed traces in your monitoring stack
- (Optionally) Added custom spans for deeper insight

---

## Resources

- [OpenTelemetry Python Docs](https://opentelemetry.io/docs/instrumentation/python/)
- [FastAPI Instrumentation Guide](https://opentelemetry-python-contrib.readthedocs.io/en/latest/instrumentation/fastapi/fastapi.html)
- [Grafana Tempo](https://grafana.com/oss/tempo/)
- [Jaeger Tracing](https://www.jaegertracing.io/)
