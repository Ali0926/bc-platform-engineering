# Lab Environment: Kubernetes Cluster Cheat Sheet

## Overview

This document provides all the commands you need to interact with the shared Kubernetes lab cluster. Bookmark this page—you'll reference it throughout the monitoring labs.

---

## Cluster Authentication

### Login to the Cluster

```bash
# Authenticate with the lab cluster
az aks get-credentials --resource-group <RESOURCE_GROUP> --name <CLUSTER_NAME>
```

Your instructor will provide the resource group and cluster name.

### Verify Connection

```bash
# Test that you can reach the cluster
kubectl cluster-info

# Check your current context
kubectl config current-context

# List all contexts (if you have multiple clusters)
kubectl config get-contexts
```

---

## kubectl Essentials

### Get Resources

```bash
# List all pods in default namespace
kubectl get pods

# List pods in a specific namespace
kubectl get pods -n monitoring

# List pods across ALL namespaces
kubectl get pods -A

# List services
kubectl get svc
kubectl get svc -n monitoring

# List deployments
kubectl get deployments -n monitoring

# Get detailed info about a specific pod
kubectl describe pod <POD_NAME> -n monitoring
```

### View Logs

```bash
# Get logs from a pod
kubectl logs <POD_NAME> -n monitoring

# Get logs from the last 5 minutes
kubectl logs <POD_NAME> -n monitoring --since=5m

# Get logs from the last hour
kubectl logs <POD_NAME> -n monitoring --since=1h

# Get logs from the last 100 lines
kubectl logs <POD_NAME> -n monitoring --tail=100

# Follow logs in real-time (like tail -f)
kubectl logs -f <POD_NAME> -n monitoring

# Get logs from a specific container (multi-container pods)
kubectl logs <POD_NAME> -c <CONTAINER_NAME> -n monitoring

# Get logs from a previous container instance (after restart)
kubectl logs <POD_NAME> -n monitoring --previous
```

### Find Pod Names Quickly

```bash
# List pods with labels
kubectl get pods -n monitoring --show-labels

# Filter pods by label
kubectl get pods -n monitoring -l app=telemetry-api

# Get just the pod name (useful for scripting)
kubectl get pods -n monitoring -l app=telemetry-api -o jsonpath='{.items[0].metadata.name}'
```



---

## ArgoCD Access

### Login to ArgoCD UI

1. Get the ArgoCD server URL:
   ```bash
   kubectl get svc argocd-server -n argocd
   ```

2. If using port-forward:
   ```bash
   kubectl port-forward svc/argocd-server 8080:443 -n argocd
   ```
   Then open: https://localhost:8080

3. Get the initial admin password:
   ```bash
   kubectl get secret argocd-initial-admin-secret -n argocd -o jsonpath='{.data.password}' | base64 -d
   ```

4. Login with:
   - Username: `admin`
   - Password: (from command above)

### ArgoCD CLI

```bash
# Login via CLI
argocd login <ARGOCD_SERVER> --username admin --password <PASSWORD>

# List applications
argocd app list

# Get application status
argocd app get <APP_NAME>

# Sync an application (deploy latest)
argocd app sync <APP_NAME>

# View application history
argocd app history <APP_NAME>
```

---

## Grafana Access

### Connect to Grafana

1. Get the Grafana service:
   ```bash
   kubectl get svc grafana -n monitoring
   ```

2. If using LoadBalancer, use the EXTERNAL-IP. Otherwise port-forward:
   ```bash
   kubectl port-forward svc/grafana 3000:3000 -n monitoring
   ```

3. Open http://localhost:3000 (or the external IP)

4. Default credentials:
   - Username: `admin`
   - Password: `admin` (or check with your instructor)

---

## Available Metrics Sources

The cluster has **Grafana Alloy** deployed, which collects metrics from:

| Source | What It Provides |
|--------|------------------|
| **Node Exporter** | Host-level metrics (CPU, memory, disk, network) |
| **Kube State Metrics** | Kubernetes object states (pods, deployments, nodes) |
| **cAdvisor** | Container resource usage |

### ⚠️ Important: Metric Name Changes with Alloy

Grafana Alloy uses slightly different metric names than traditional Prometheus setups. When searching for metrics or following older tutorials, be aware:

| Traditional Name | Alloy Equivalent |
|------------------|------------------|
| `node_cpu_seconds_total` | May appear as `node_cpu_seconds_total` or with additional labels |
| `kube_pod_status_phase` | Same name, but verify labels |

**Tip:** Always use Grafana's metric browser to discover available metrics rather than assuming names from documentation.

---

## Exercise: Explore Kubernetes Metrics

Your cluster exposes many `kube_*` metrics from Kube State Metrics. Your task is to explore these and build something useful.

### Step 1: Discover Available Metrics

In Grafana Explore (with Prometheus data source), type:

```promql
kube_
```

The autocomplete will show all available Kubernetes metrics. Browse through them!

### Step 2: Interesting Metrics to Explore

Try querying these and see what data you get:

```promql
# Pod status
kube_pod_status_phase

# Container restarts (indicates problems!)
kube_pod_container_status_restarts_total

# Pod ready status
kube_pod_status_ready

# Deployment replicas
kube_deployment_status_replicas
kube_deployment_status_replicas_available

# Node status
kube_node_status_condition
```

### Step 3: Build a Useful Query

**Challenge:** Can you build a query that shows:

1. **Pods not in Running state:**
   ```promql
   kube_pod_status_phase{phase!="Running", phase!="Succeeded"} == 1
   ```

2. **Containers that have restarted recently:**
   ```promql
   increase(kube_pod_container_status_restarts_total[1h]) > 0
   ```

3. **Deployments with unavailable replicas:**
   ```promql
   kube_deployment_status_replicas - kube_deployment_status_replicas_available > 0
   ```

4. **Node memory pressure:**
   ```promql
   kube_node_status_condition{condition="MemoryPressure", status="true"} == 1
   ```

### Step 4: Create a Dashboard Panel

Pick one of the queries above (or create your own!) and add it to a Grafana dashboard:

1. Go to **Dashboards** → **New** → **New Dashboard**
2. Add a visualization
3. Use your PromQL query
4. Choose an appropriate visualization:
   - **Stat** for single values
   - **Table** for lists
   - **Time series** for changes over time

### Bonus Challenges

1. Create a panel showing the **restart count by namespace**:
   ```promql
   sum by (namespace) (kube_pod_container_status_restarts_total)
   ```

2. Show **pod count by namespace**:
   ```promql
   count by (namespace) (kube_pod_info)
   ```

3. Find metrics for **resource requests and limits**:
   ```promql
   kube_pod_container_resource_requests
   kube_pod_container_resource_limits
   ```

---

## Quick Reference Card

| Task | Command |
|------|---------|
| List pods | `kubectl get pods -n <namespace>` |
| Get logs (last 5m) | `kubectl logs <pod> --since=5m` |
| Follow logs | `kubectl logs -f <pod>` |
| Port forward | `kubectl port-forward svc/<svc> <local>:<remote>` |
| Describe resource | `kubectl describe pod/<pod>` |
| Get all namespaces | `kubectl get ns` |
| ArgoCD password | `kubectl get secret argocd-initial-admin-secret -n argocd -o jsonpath='{.data.password}' \| base64 -d` |

---

## Troubleshooting

### "Unable to connect to the server"

```bash
# Re-authenticate
az aks get-credentials --resource-group <RG> --name <CLUSTER> --overwrite-existing
```

### "No resources found"

```bash
# Check you're in the right namespace
kubectl get pods -A | grep <what-youre-looking-for>
```

### Port forward stops working

```bash
# Kill existing forwards and restart
pkill -f "kubectl port-forward"
kubectl port-forward svc/grafana 3000:3000 -n monitoring
```

### Can't see metrics in Grafana

1. Check Prometheus is running: `kubectl get pods -n monitoring | grep prometheus`
2. Verify the data source is configured in Grafana
3. Use the metric browser to see what's actually available

---

## Next Steps

With access to the cluster and Grafana, you're ready to:
- Build dashboards with `kube_*` metrics
- Explore PromQL queries in the Explore view
- Monitor your deployed applications
