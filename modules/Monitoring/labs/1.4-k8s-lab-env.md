# Lab: Kubernetes Monitoring Environment Setup

## Overview

In this lab, you'll set up a Kubernetes cluster on AWS EKS and deploy a monitoring stack using GitOps with ArgoCD. By the end, you'll have Prometheus, Loki, Grafana, and Alloy running—all managed through Git.

---

## Part 1: Clone the Repository

### Step 1: Clone the Repository

Open AWS CloudShell or your terminal with AWS credentials configured:

```bash
git clone https://github.com/d-blanco/k8s-argo-monitoring.git
cd k8s-argo-monitoring
```

---

### Step 2: Create Cluster

Install eksctl
```
# if you need to make space
# rm -rf k8s-monitoring

mkdir -p $HOME/.local/bin
cd $HOME/.local/bin

curl --silent --location "https://github.com/weaveworks/eksctl/releases/latest/download/eksctl_$(uname -s)_amd64.tar.gz" | tar xz -C /tmp
sudo mv /tmp/eksctl $HOME/.local/bin
```

Create SSH Key
```
ssh-keygen -t rsa -b 2048 -f ~/.ssh/gitops-eks-key

aws ec2 import-key-pair \
  --region us-east-1 \
  --key-name gitops-eks-key \
  --public-key-material fileb://~/.ssh/gitops-eks-key.pub
```
Create cluster
```
eksctl create cluster \
  --name monitoring-lab \
  --region us-east-1 \
  --nodes 3 \
  --node-type t3.large \
  --with-oidc \
  --ssh-access \
  --ssh-public-key gitops-eks-key \
  --managed
```

Add CSI Addon
```
eksctl create addon \
  --name aws-ebs-csi-driver \
  --cluster monitoring-lab \
  --region us-east-1
```

### Step 3: Configure kubectl

```bash
aws eks update-kubeconfig --region us-east-1 --name monitoring-lab
```

Verify access:

```bash
kubectl get nodes
```

You should see nodes in `Ready` status.

---

## Part 3: Install ArgoCD

### Step 1: Deploy ArgoCD

```bash
kubectl create namespace argocd
kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
```

Wait for pods to be ready:

```bash
kubectl get pods -n argocd -w
```

Press `Ctrl+C` when all pods show `Running`.

### Step 2: Expose the ArgoCD UI

```bash
kubectl patch svc argocd-server -n argocd -p '{"spec": {"type": "LoadBalancer"}}'
```

Get the external URL (may take 2-3 minutes):

```bash
kubectl get svc argocd-server -n argocd
```

### Step 3: Get the Admin Password

```bash
kubectl -n argocd get secret argocd-initial-admin-secret \
  -o jsonpath="{.data.password}" | base64 -d && echo
```

### Step 4: Log Into ArgoCD

1. Open your browser to: `https://<ARGOCD-EXTERNAL-DNS>`
2. Accept the self-signed certificate warning
3. Log in with:
   - **Username**: `admin`
   - **Password**: (from previous step)

---

## Part 4: Deploy the Monitoring Stack

We'll use the **App of Apps** pattern: one ArgoCD Application points to a folder of Application manifests, and ArgoCD creates them all automatically.

### Step 1: Create the App of Apps

1. In ArgoCD UI, click **+ New App**
2. Fill in the form:

| Field | Value |
|-------|-------|
| **Application Name** | `monitoring-apps` |
| **Project** | `default` |
| **Sync Policy** | `Automatic` |
| **Prune Resources** | ✓ (checked) |
| **Self Heal** | ✓ (checked) |
| **Repository URL** | `https://github.com/d-blanco/k8s-argo-monitoring` |
| **Revision** | `HEAD` |
| **Path** | `apps/argocd-apps` |
| **Cluster URL** | `https://kubernetes.default.svc` |
| **Namespace** | `argocd` |

3. Click **Create**

### Step 2: Watch the Apps Deploy

1. In the ArgoCD UI, you'll see `monitoring-apps` appear
2. Click on it to see the child applications being created:
   - `prometheus`
   - `loki`
   - `grafana`
   - `k8s-monitoring`
3. Click into each application to watch the Kubernetes resources being created in real-time
4. Wait until all applications show **Healthy** and **Synced** status

This may take 5-10 minutes as Helm charts are rendered and pods start up.

### Step 3: Verify the Stack is Running

```bash
kubectl get pods -n monitoring
```

You should see pods for Prometheus, Loki, Grafana, and Alloy collectors.

---

## Part 5: Explore Your Monitoring Stack

### Step 1: Access Grafana

Get the Grafana LoadBalancer URL:

```bash
kubectl get svc -n monitoring grafana
```

Open the EXTERNAL-IP in your browser and log in:
- **Username**: `admin`
- **Password**: `admin`

### Step 2: Query Metrics with Prometheus

1. In Grafana, go to **Explore** (compass icon)
2. Ensure **Prometheus** is selected as the data source
3. Enter this PromQL query:

```promql
sum(kube_pod_status_ready)
```

4. Click **Run query** - you should see the count of ready pods in your cluster

### Step 3: Query Logs with Loki

1. Still in **Explore**, change the data source to **Loki**
2. Enter this LogQL query:

```logql
{namespace="monitoring"}
```

3. Click **Run query** - you should see logs from all pods in the monitoring namespace

---

## Summary

| What You Did | Why It Matters |
|--------------|----------------|
| Cloned the monitoring repo | Access to pre-configured manifests |
| Created EKS with Terraform | Infrastructure as Code |
| Installed ArgoCD | GitOps controller |
| Deployed full stack via App of Apps | One app deploys everything |
| Queried metrics in Grafana | PromQL basics |
| Queried logs in Grafana | LogQL basics |

---

## Next Steps

Your monitoring stack is now running! In the next labs, you'll:
- Build **Grafana dashboards**
- Write advanced **PromQL** queries
- Create **alerts** based on SLOs
- Explore **LogQL** for log analysis
